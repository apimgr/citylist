# CityList API

> A high-performance, self-contained API server for accessing global city information with 200,000+ cities worldwide

[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](https://opensource.org/licenses/MIT)
[![Go Version](https://img.shields.io/badge/Go-1.23-00ADD8?logo=go)](https://golang.org)
[![Docker](https://img.shields.io/badge/Docker-Multi--arch-2496ED?logo=docker)](https://ghcr.io/apimgr/citylist)

## About

CityList API is a production-ready RESTful API server providing comprehensive access to global city data. Built with Go, it features embedded SQLite storage, a modern web interface, and complete authentication system - all in a single static binary.

**Key Features:**
- 🌍 **200,000+ Cities** - Comprehensive global coverage
- 🚀 **Single Binary** - No external dependencies, fully self-contained
- 🔐 **Secure** - Built-in admin authentication and audit logging
- 📱 **Modern UI** - Dark-themed, responsive web interface
- 🐳 **Multi-arch** - Docker images for amd64 and arm64
- ⚡ **Fast** - Pure Go with in-memory indexing
- 🔍 **Rich API** - Search, filter by country, pagination

## Production Deployment

### Docker (Recommended)

**Pull and run the official image:**

```bash
# Pull latest image
docker pull ghcr.io/apimgr/citylist:latest

# Run container
docker run -d \
  --name citylist \
  -p 80:80 \
  -v ./data:/data \
  -v ./config:/config \
  ghcr.io/apimgr/citylist:latest

# View logs
docker logs -f citylist
```

**Using Docker Compose:**

```bash
# Start services
docker-compose up -d

# View status
docker-compose ps

# View logs
docker-compose logs -f

# Stop services
docker-compose down
```

Access the server at: `http://your-server:64366`

### Pre-built Binaries

Download the latest release for your platform:

**Linux (AMD64):**
```bash
wget https://github.com/apimgr/citylist/releases/latest/download/citylist-linux-amd64
chmod +x citylist-linux-amd64
./citylist-linux-amd64 --port 80
```

**Linux (ARM64):**
```bash
wget https://github.com/apimgr/citylist/releases/latest/download/citylist-linux-arm64
chmod +x citylist-linux-arm64
./citylist-linux-arm64 --port 80
```

**macOS (Apple Silicon):**
```bash
wget https://github.com/apimgr/citylist/releases/latest/download/citylist-darwin-arm64
chmod +x citylist-darwin-arm64
./citylist-darwin-arm64 --port 80
```

**Windows:**
```powershell
# Download citylist-windows-amd64.exe
.\citylist-windows-amd64.exe --port 80
```

### Systemd Service (Linux)

```bash
# Create service user
sudo useradd -r -s /bin/false citylist

# Copy binary
sudo cp citylist-linux-amd64 /usr/local/bin/citylist
sudo chmod +x /usr/local/bin/citylist

# Create systemd service
sudo tee /etc/systemd/system/citylist.service << 'EOF'
[Unit]
Description=CityList API Server
After=network.target

[Service]
Type=simple
User=citylist
Group=citylist
ExecStart=/usr/local/bin/citylist --port 80
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# Enable and start
sudo systemctl daemon-reload
sudo systemctl enable citylist
sudo systemctl start citylist
sudo systemctl status citylist
```

### Configuration

**Environment Variables:**
```bash
CONFIG_DIR=/config      # Configuration directory
DATA_DIR=/data          # Data directory
LOGS_DIR=/data/logs     # Log directory
PORT=80                 # Server port
```

**Command Line Options:**
```bash
./citylist --help              # Show all options
./citylist --version           # Show version
./citylist --port 80           # Set HTTP port
./citylist --address 0.0.0.0   # Set listen address
./citylist --dev               # Development mode
```

**Admin Credentials:**

On first run, admin credentials are auto-generated and saved to `{CONFIG_DIR}/admin_credentials`:
- Username: `administrator`
- Password: `<auto-generated>`
- API Token: `<auto-generated>`

**⚠️ Store these credentials securely - they are shown only once!**

## API Endpoints

### Get All Cities (Paginated)
```bash
GET /api/v1/cities?limit=10&offset=0
```

### Search Cities by Name
```bash
GET /api/v1/cities/search?q=London
```

### Get Cities by Country Code
```bash
GET /api/v1/cities/country/US
```

### Health Check
```bash
GET /healthz
```

## Kubernetes Deployment

**Example Kubernetes manifest:**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: citylist
spec:
  replicas: 3
  selector:
    matchLabels:
      app: citylist
  template:
    metadata:
      labels:
        app: citylist
    spec:
      containers:
      - name: citylist
        image: ghcr.io/apimgr/citylist:latest
        ports:
        - containerPort: 80
        env:
        - name: PORT
          value: "80"
        resources:
          limits:
            cpu: "1"
            memory: "512Mi"
          requests:
            cpu: "250m"
            memory: "128Mi"
---
apiVersion: v1
kind: Service
metadata:
  name: citylist
spec:
  selector:
    app: citylist
  ports:
  - port: 80
    targetPort: 80
  type: LoadBalancer
```

## Technology Stack

- **Language**: Go 1.23
- **Database**: SQLite (pure Go - modernc.org/sqlite)
- **Router**: Chi v5
- **Frontend**: Vanilla JavaScript, CSS3
- **Design**: Dark theme, mobile-first responsive
- **Architecture**: Single static binary with embedded assets

## Data Source

City data is embedded in the binary from `src/data/citylist.json`:
- **City ID** - Unique identifier
- **City Name** - Official city name
- **Country Code** - ISO 3166-1 alpha-2
- **Coordinates** - Latitude and Longitude

## License

MIT License - See [LICENSE.md](LICENSE.md) for details

---

## Development

### Prerequisites

- Go 1.23 or later
- Docker (optional, for containerized builds)
- Make

### Building from Source

```bash
# Clone repository
git clone https://github.com/apimgr/citylist.git
cd citylist

# Build for all platforms
make build

# Build for current platform only
CGO_ENABLED=0 go build -o citylist ./src

# Run locally
./binaries/citylist --port 8080 --dev
```

### Development Mode

```bash
# Run with hot reload and debug endpoints
./citylist --port 8080 --dev
```

Development mode includes:
- Enhanced logging
- Debug endpoints at `/debug/routes`
- CORS enabled for all origins

### Running Tests

```bash
# Run all tests
make test

# Run with coverage
go test -v -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
```

### Build System

The Makefile provides 4 main targets:

```bash
make build      # Build for all platforms (Linux, Windows, macOS, BSD)
make release    # Create GitHub release with auto-version increment
make docker     # Build and push multi-arch Docker image
make test       # Run all tests with coverage
```

**Version Management:**

Versions are stored in `release.txt` using semantic versioning:
```bash
make build VERSION=1.0.0    # Specific version
make release                # Auto-increment patch version
```

### Project Structure

```
.
├── src/
│   ├── main.go              # Entry point
│   ├── auth/                # Authentication layer
│   ├── database/            # Database operations
│   ├── server/              # HTTP server & routes
│   ├── utils/               # Utilities (network, etc.)
│   ├── static/              # Embedded CSS, JS, assets
│   └── data/                # Embedded city data JSON
├── binaries/                # Built binaries (gitignored)
├── releases/                # Release artifacts (gitignored)
├── rootfs/                  # Docker volume mounts
│   ├── data/citylist/       # Application data
│   └── config/citylist/     # Configuration files
├── Makefile                 # Build automation
├── Dockerfile               # Multi-stage container build
├── docker-compose.yml       # Compose configuration
├── Jenkinsfile              # CI/CD pipeline
├── go.mod                   # Go dependencies
└── release.txt              # Version tracking
```

### Adding New Endpoints

1. Edit `src/server/server.go`
2. Add route in `setupRoutes()` function
3. Implement handler function
4. Follow existing patterns for responses
5. Add tests in `test/` directory

**Example:**

```go
// In setupRoutes()
r.Get("/api/v1/cities/stats", s.handleCityStats)

// Handler implementation
func (s *Server) handleCityStats(w http.ResponseWriter, r *http.Request) {
    var total int
    s.db.QueryRow("SELECT COUNT(*) FROM cities").Scan(&total)

    response := map[string]interface{}{
        "success": true,
        "data": map[string]int{"total": total},
        "timestamp": time.Now().UTC().Format(time.RFC3339),
    }

    w.Header().Set("Content-Type", "application/json")
    json.NewEncoder(w).Encode(response)
}
```

### Docker Development

```bash
# Build development image (not pushed)
make docker-dev

# Run development container
docker run -p 8080:80 citylist:dev

# Use Docker Compose for development
docker-compose up -d
docker-compose logs -f
```

### Database Schema

The SQLite database includes:

**Tables:**
- `cities` - City data with coordinates
- `admin_credentials` - Admin authentication
- `settings` - Server configuration (key-value store)
- `audit_log` - Action audit trail

**Settings Categories:**
- `server.*` - Server configuration
- `security.*` - Security policies
- `features.*` - Feature toggles

### Contributing

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

**Code Style:**
- Follow [Effective Go](https://golang.org/doc/effective_go)
- Run `gofmt` before committing
- Add tests for new features
- Update documentation

### Troubleshooting

**Binary won't start:**
```bash
# Check if binary is executable
chmod +x citylist

# Run with debug logging
./citylist --dev

# Check version
./citylist --version
```

**Docker container won't start:**
```bash
# Check logs
docker logs citylist

# Inspect container
docker inspect citylist

# Check health
docker ps
```

**Port already in use:**
```bash
# Change port
./citylist --port 8081

# Or for Docker
docker run -p 8081:80 ghcr.io/apimgr/citylist:latest
```

---

## Official Site

- **GitHub**: https://github.com/apimgr/citylist
- **Docker Hub**: https://ghcr.io/apimgr/citylist
- **Documentation**: https://citylist.readthedocs.io

## Support

For issues, questions, or contributions:
- Open an issue on [GitHub Issues](https://github.com/apimgr/citylist/issues)
- Check existing [documentation](https://citylist.readthedocs.io)

---

**Built with Go | MIT License**
